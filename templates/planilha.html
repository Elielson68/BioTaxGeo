<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Planilha</title>
        <link rel="stylesheet" type="text/css" href="../static/css/style.css"/>
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
        <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
    </head>
    <body>
        <nav class="navbar navbar-expand-lg navbar-light bg-light" >
            <a class="navbar-brand" href="#">SpecieGeo <span class="sr-only">(current)</span></a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
        </nav>
        
        <h1 style="text-align: center;">Verificação dos dados da planilha</h1> <hr>

        <!--______________________________________PLANILHA______________________________________________________-->
        <div id="planilha">
          <table class="table table-dark" id="tabela_planilha">
            <thead id="thead_tabela">
              <tr id="tr_thead">
                <th scope="col">Nome Científico</th>
              </tr>
            </thead>
            <tbody id="tbody_tabela">
            </tbody>
          </table>
        </div>
        <div>
          <form action="http://localhost:8080/salvar" method = "POST" enctype = "multipart/form-data">
            <input type="text" name = "dados" value="" hidden="hidden" id="dados"/> 
            <input id="submit_home" type="submit" value="Salvar alterações" class="btn btn-success"/>
          </form>
        </div>

        <script>
          var tabela = document.getElementById("tabela_planilha");
          var thead = document.getElementById("thead_tabela")
          var tr_head = document.getElementById("tr_thead")
          var tbody = document.getElementById("tbody_tabela")
          var titulos = "{{titulos}}"
          var celula_errada;
          titulos = titulos.replace(/&#39;/g,'"');
          titulos = JSON.parse(titulos)
          verificacao = "{{verificacao}}"
          verificacao = verificacao.replace(/&#34;/g,'"');
          verificacao = JSON.parse(verificacao)
          var valores_modificados = []
          console.log(verificacao)
          
          function CriarCabecario(titulo){
            var th = document.createElement("th");
            th.setAttribute("scope","col");
            th.innerHTML = titulo;
            tr_head.appendChild(th);
          }

          function CriarLinhas(nome, quantidade, precisao, corretude, sugestao, genus, specie){
            var tr_body = document.createElement("tr");
            if(corretude == "NONE"){
              var td_nome = document.createElement("td");
              td_nome.innerHTML = nome;
              td_nome.style = "color: red;vertical-align: middle;";

              var sugestao_formatada = "";
              
              for(nominho in sugestao){
                sugestao_formatada += nominho+": "+sugestao[nominho]+"%<br>"
              }
              var td_sugestao = document.createElement("td");
              td_sugestao.innerHTML = sugestao_formatada;
              td_sugestao.style = "color: green;vertical-align: middle;";
            }
            else if(corretude == "FUZZY"){
              var td_nome = document.createElement("td");
              td_nome.innerHTML = "<u>"+nome+"</u>";
              td_nome.addEventListener("click",AlterandoDados)
              td_nome.setAttribute("data-toggle","modal")
              td_nome.setAttribute("data-target","#exampleModal")
              td_nome.style = "color: red;"
              var td_sugestao = document.createElement("td");
              td_sugestao.innerHTML = sugestao;
              td_sugestao.style = "color: green;"
              td_sugestao.id = nome
            }
            else{
              var td_nome = document.createElement("td");
              td_nome.innerHTML = nome;
              var td_sugestao = document.createElement("td");
              td_sugestao.innerHTML = sugestao;
            }
            tbody.appendChild(tr_body);
            
            var td_quantidade = document.createElement("td");
            td_quantidade.innerHTML = quantidade;
            td_quantidade.style = "vertical-align: middle;";
            var td_precisao = document.createElement("td");
            td_precisao.innerHTML = precisao;
            td_precisao.style = "vertical-align: middle;";
            var td_corretude = document.createElement("td");
            td_corretude.innerHTML = corretude;
            td_corretude.style = "vertical-align: middle;";
            var td_genus = document.createElement("td")
            td_genus.innerHTML = genus
            var td_specie = document.createElement("td")
            td_specie = specie

            tr_body.appendChild(td_nome);
            tr_body.appendChild(td_quantidade);
            tr_body.appendChild(td_precisao);
            tr_body.appendChild(td_corretude);
            tr_body.appendChild(td_sugestao);
            tr_body.appendChild(td_genus);
            tr_body.appendChild(td_specie);
          }
          
          function AlterandoDados(){
            texto = document.getElementById("texto_modal")
            celula_errada = this
            valor_errado = this.innerHTML.replace("/","").replace(/<u>/g,"");
            texto.innerHTML = "Deseja alterar o valor de "+valor_errado+" para "+verificacao[valor_errado]["Sugestão de Nome"]+"?<br>Serão alterados "+verificacao[valor_errado]["quantidade"]+" valores de sua planilha."
          }
          function SalvarAlteracao(){
            key_objeto = celula_errada.innerHTML.replace("/","").replace(/<u>/g,"");
            valores_modificados[0].push(key_objeto);
            valores_modificados[1].push(verificacao[key_objeto]["Sugestão de Nome"]);
            celula_errada.innerHTML = verificacao[key_objeto]["Sugestão de Nome"];
            celula_errada.style = "color: white;";
            celula_errada.setAttribute("data-toggle","");
            celula_errada.setAttribute("data-target","");
            modificado = document.getElementById(key_objeto);
            modificado.innerHTML = "Modificado";

            dados = document.getElementById("dados")
            enviar_valores = JSON.stringify(valores_modificados)
            dados.innerHTML =  enviar_valores
          }
          for(nome in verificacao){
            for(titu in verificacao[nome]){
              CriarCabecario(titu)
            }
            break;
          }
          
          for(nome in verificacao){
            CriarLinhas(nome, verificacao[nome]["quantidade"],verificacao[nome]["precisão"],verificacao[nome]["corretude"],verificacao[nome]["Sugestão de Nome"],verificacao[nome]["Genus"], verificacao[nome]["Specie"])
          }
          
          
        </script>
  <!-- Modal -->
  <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">Alterar valor</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <label id="texto_modal">
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-primary" onclick="SalvarAlteracao()" data-dismiss="modal">Salvar alteração</button>
        </div>
      </div>
    </div>
  </div>
    </body>
</html>